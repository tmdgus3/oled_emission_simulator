<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OLED Optical Simulator</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    input, select, button { margin: 0.5rem; padding: 0.4rem; }
    .layer-row { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>OLED Emission Simulator</h1>

  <div id="layer-container">
    <div class="layer-row">
      <input type="text" placeholder="Layer name" value="Anode" />
      <input type="text" placeholder="Material" value="ITO" />
      <input type="number" placeholder="Thickness (nm)" value="40" />
      <button onclick="removeLayer(this)">‚ùå</button>
    </div>
    <div class="layer-row">
      <input type="text" placeholder="Layer name" value="HTL" />
      <input type="text" placeholder="Material" value="NPB" />
      <input type="number" placeholder="Thickness (nm)" value="75" />
      <button onclick="removeLayer(this)">‚ùå</button>
    </div>
    <div class="layer-row">
      <input type="text" placeholder="Layer name" value="EML" />
      <input type="text" placeholder="Material" value="Alq3" />
      <input type="number" placeholder="Thickness (nm)" value="60" />
      <button onclick="removeLayer(this)">‚ùå</button>
    </div>
    <div class="layer-row">
      <input type="text" placeholder="Layer name" value="Cathode" />
      <input type="text" placeholder="Material" value="Al" />
      <input type="number" placeholder="Thickness (nm)" value="100" />
      <button onclick="removeLayer(this)">‚ùå</button>
    </div>
  </div>
  <button onclick="addLayer()">‚ûï Add Layer</button>

  <div>
    <label>Emitter Position (0~1):</label>
    <input type="number" id="emitter_pos" value="0.5" step="0.05" min="0" max="1" />
    <label>Viewing Angle (deg):</label>
    <input type="number" id="view_angle" value="0" step="1" min="0" max="89" />
  </div>

  <button onclick="simulate()">üîç Calculate Emission</button>

  <div id="plot" style="width:100%;max-width:800px;height:400px;margin-top:30px;"></div>

  <script>
    function addLayer() {
      const div = document.createElement("div");
      div.className = "layer-row";
      div.innerHTML = `
        <input type="text" placeholder="Layer name" />
        <input type="text" placeholder="Material" />
        <input type="number" placeholder="Thickness (nm)" />
        <button onclick="removeLayer(this)">‚ùå</button>
      `;
      document.getElementById("layer-container").appendChild(div);
    }

    function removeLayer(btn) {
      btn.parentElement.remove();
    }

    async function simulate() {
      const layers = [];
      const rows = document.querySelectorAll(".layer-row");
      for (let row of rows) {
        const inputs = row.querySelectorAll("input");
        layers.push({
          name: inputs[0].value,
          material: inputs[1].value,
          thickness: parseFloat(inputs[2].value),
        });
      }

      const emitter_pos = parseFloat(document.getElementById("emitter_pos").value);
      const view_angle = parseFloat(document.getElementById("view_angle").value);

      const payload = {
        stack: layers,
        emitter_position: emitter_pos,
        view_angle: view_angle,
      };

      const response = await fetch("http://localhost:8000/emission", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const result = await response.json();
      plot(result.wavelength_nm, result.intensity);
    }

    function plot(wavelengths, intensity) {
      const trace = {
        x: wavelengths,
        y: intensity,
        type: 'scatter',
        mode: 'lines',
        name: 'Emission Spectrum'
      };
      const layout = {
        title: 'Emission Spectrum',
        xaxis: { title: 'Wavelength (nm)' },
        yaxis: { title: 'Intensity (normalized)' }
      };
      Plotly.newPlot("plot", [trace], layout);
    }
  </script>
</body>
</html>
